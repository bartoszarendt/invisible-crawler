services:
  postgres:
    ports:
      - "127.0.0.1:${POSTGRES_HOST_PORT:-15432}:5432"
    deploy:
      resources:
        limits:
          cpus: "0.50"
          memory: 768M
        reservations:
          cpus: "0.10"
          memory: 256M

  redis:
    ports:
      - "127.0.0.1:${REDIS_HOST_PORT:-16379}:6379"
    deploy:
      resources:
        limits:
          cpus: "0.25"
          memory: 256M
        reservations:
          cpus: "0.05"
          memory: 128M

  crawler:
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 2G
        reservations:
          cpus: "0.25"
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "10"
    command:
      [
        "sh",
        "-c",
        "exec scrapy crawl ${CRAWLER_SPIDER:-discovery} -a max_pages=${CRAWLER_MAX_PAGES:-0}",
      ]

  autoheal:
    image: willfarrell/autoheal:1.2.0
    restart: unless-stopped
    environment:
      AUTOHEAL_CONTAINER_LABEL: autoheal
      AUTOHEAL_INTERVAL: ${AUTOHEAL_INTERVAL:-30}
      AUTOHEAL_START_PERIOD: ${AUTOHEAL_START_PERIOD:-120}
      AUTOHEAL_DEFAULT_STOP_TIMEOUT: ${AUTOHEAL_DEFAULT_STOP_TIMEOUT:-10}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    profiles: ["autoheal"]
